---
title: "ETF Selection"
author: "Gabriel Yiu"
date: "February 18, 2021"
output:
  html_document:
    code_folding: hide
    toc: True
    toc_depth: 2
    toc_float: True
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load and Clean Data

```{r load, warning=FALSE, message=FALSE}
library("quantmod")
library("xts")
library("zoo")
library("rmgarch")
library("MASS")
library("ggplot2")
library("dplyr")

load("price_data.RData")

test = end

lastrow <- nrow(logreturns[paste("/", test, sep = "")])
testdays <- nrow(logreturns[paste(test, "/" , sep = "")])

plot(cbind(logreturns$VAB.TO, logreturns$VCN.TO), legend.loc = "topleft",
     main = "Canadian Stocks vs Bonds")
```

## Garch Fitting
```{r fit, warning=FALSE, message=FALSE}
# specify i.i.d. model for the univariate time series
ugarch_spec <- ugarchspec(mean.model = list(armaOrder = c(0,0), include.mean = TRUE), 
                          variance.model = list(model = "sGARCH", garchOrder = c(1,1)))

# specify DCC model
dcc_spec <- dccspec(uspec = multispec(replicate(ugarch_spec, n = 7)),
                    VAR = TRUE, lag = 0, model = "DCC", dccOrder = c(1,1))

# estimate model
garchdcc_fit <- dccfit(dcc_spec, data = logreturns)
garchdcc_fit
```

## Portfolio Construction
```{r Portfolio, warning=FALSE, message=FALSE}
set.seed(7829)

rf <- 0.0015
raw_frcst <- dccforecast(garchdcc_fit, n.ahead = 126)
var_cov <- raw_frcst@mforecast$H[[1]][,,126] * 252
mus <- raw_frcst@model$mu[1,]
names(mus) <- symbols
ann_mu <- mus * 252
sharpe_ratio <- function(weights){
  return((weights %*% ann_mu - rf)/sqrt(t(weights) %*% (var_cov %*% weights)))
}

sol <- optim(rep(1/length(symbols),length(symbols)), sharpe_ratio,
             lower = rep(0, length(symbols)), method = "L-BFGS-B", control = list(fnscale = -1))
sol <- sol$par / sum(sol$par)

num_port <- 100000
all_wts <- matrix(nrow = num_port, ncol= length(symbols))
port_returns <- vector('numeric', length = num_port)
port_risk <- vector('numeric', length = num_port)
sr <- vector('numeric', length = num_port)
all_wts[1,] <- sol
port_returns[1] <- sum(sol * ann_mu)
port_risk[1] <- sqrt(t(sol) %*% (var_cov  %*% sol))
sr[1] <- sharpe_ratio(sol)

for (i in 2:num_port) {
  
  wts <- runif(length(symbols))
  wts <- wts/sum(wts)

  all_wts[i,1:length(symbols)] <- wts
  
  port_returns[i] <- sum(wts * ann_mu)
  port_risk[i] <- sqrt(t(wts) %*% (var_cov  %*% wts))
  sr[i] <- sharpe_ratio(wts)
  
}

portfolio_values <- data.frame(cbind(all_wts, port_returns, port_risk, sr))
colnames(portfolio_values) <- c(paste("Wt.", symbols,sep=""), "Returns", "Risk", "SharpeRatio")

min_var <- portfolio_values[which.min(portfolio_values$Risk),]
max_sr <- portfolio_values[which.max(portfolio_values$SharpeRatio),]

print(max_sr)

opt_wts <- as.vector(unlist(
  portfolio_values[which.max(portfolio_values$SharpeRatio), paste("Wt.", symbols,sep="")]))
ggplot(data = portfolio_values, aes(x = Risk, y = Returns, color = SharpeRatio)) +
  geom_point() +
  geom_abline(intercept = rf, slope = max_sr$SharpeRatio, color = "red") +
  theme_bw()

nsim <- 5000
simulations <- dccsim(garchdcc_fit, n.sim = 252, m.sim = nsim,
                      startMethod = c("sample"), rseed = 7829)
rts <- 1:nsim
for (i in 1:nsim){
  rts[i] <- sum(simulations@msim$simX[[i]] %*% opt_wts)
}

VaR <- function(wt, initial = 10000, p = 0.01, ti = 1){
  return(initial * (1 - wt) * (1 + rf) ^ ti + wt * initial * quantile(exp(rts), 0.01))
}

TVaR <- function(wt, initial = 10000, p = 0.01, ti = 1){
  return(
    initial * (1 - wt) * (1 + rf) ^ ti +
      wt * initial * (exp(mean(rts[which(rts <= quantile(rts, 0.01))]))))
}

ER <- function(wt, initial = 10000, p = 0.01, ti = 1){
  return(initial * ((1 - wt) * (1 + rf) ^ ti + wt * exp(mean(rts) * ti)))
  }

ggplot(data = data.frame(x = 0)) +
  stat_function(fun = TVaR, aes(color = "ES 99%")) +
  stat_function(fun = ER, aes(color = "Expected")) +
  stat_function(fun = VaR, aes(color = "VaR 99%")) +
  scale_x_continuous(limits = c(0, 1)) +
  scale_color_manual(name = "Measures",
                     values = c("red", "steelblue", "darkred")) +
  labs(title = "Measures", xlab = "Portfolio Weight", ylab = "Value") +
  theme_bw()

```

